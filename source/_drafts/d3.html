<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<title>Document</title>
</head>
<body>

<svg></svg>

<script src='https://raw.githubusercontent.com/lodash/lodash/4.17.11-npm/core.min.js'></script>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script>
const data = {
	name: '贾家',
	children: [{
		name: '宁国公',
		children: [{
			name: '贾代化',
			children: [{
				name: '贾敬',
				children: [{
					name: '贾珍(妻尤氏)',
					children: [{
						name: '贾蓉(妻可卿)'
					}]
				}, {
					name: '惜春'
				}]
			}]
		}]
	}, {
		name: '荣国公',
		children: [{
			name: '贾代善(妻贾母)',
			children: [{
				name: '贾赦(妻邢夫人)',
				children: [{
					name: '贾琏(妻王熙凤)',
					children: [{
						name: '巧姐'
					}]
				}, {
					name: '迎春'
				}, {
					name: '贾琮'
				}]
			}, {
				name: '贾政(妻王夫人)',
				children: [{
					name: '贾珠(妻李纨)',
					children: [{
						name: '贾兰'
					}]
				}, {
					name: '元春'
				}, {
					name: '宝玉'
				}, {
					name: '贾环'
				}, {
					name: '探春'
				}]
			}]
		}]
	}]
}

const width = 600
let height
const n = 6


const hierarchy = d3.hierarchy(data)
// hierarchy.sort((a, b) => (a.height - b.height) || a.data.name.localeCompare(b.data.name))
console.log(hierarchy)

const dx = 20
const dy = width / (hierarchy.height + 1)

// const root = d3.cluster()
const root = d3.tree().nodeSize([dx, dy])(hierarchy)
console.log(root)


let min = Infinity
let max = -min
root.each(d => {
	if (d.x > max) max = d.x
	if (d.x < min) min = d.x
})
height = max - min + dx * 2


const svg = d3.select('svg')
	.attr('width', width)
	.attr('height', height)
	.attr('viewBox', `0 0 ${width} ${height}`)
	// .style('width', '100%')
	// .style('height', 'auto')

let g = svg.append('g')
	.attr('stroke', '#eee')
	.attr('stroke-width', 1)
	.selectAll('path')
	.data(new Array(n-1).fill(0).map((_, i) => (i + 1) * height / n ))
	.enter().append('path')
	.attr('d', d => `M0,${d}h${width}`)

g = svg.append('g')
	.attr('stroke', '#eee')
	.attr('stroke-width', 1)
	.selectAll('path')
	.data(new Array(n-1).fill(0).map((_, i) => (i + 1) * width / n ))
	.enter().append('path')
	.attr('d', d => `M${d},0v${height}`)

g = svg.append('g')
	.attr('font-family', 'sans-serif')
	.attr('font-size', 10)
	// .attr('transform', `translate(${dy / 3}, ${dx - min})`)

const link = g.append('g')
	.attr('fill', 'none')
	.attr('stroke', '#555')
	.attr('stroke-opacity', 0.4)
	.attr('stroke-width', 1.5)
	.selectAll('path')
	.data(root.links())
	.enter().append('path')
	.attr('d', d => `
		M${d.target.y},${d.target.x}
		C${d.source.y + dy / 2},${d.target.x}
		${d.source.y + dy / 2},${d.source.x}
		${d.source.y},${d.source.x}
	`)

console.log(root.descendants())

const node = g.append('g')
	.attr('stroke-linejoin', 'round')
	.attr('stroke-width', 3)
	.selectAll('g')
	.data(root.descendants().reverse())
	.enter().append('g')
	.attr('transform', d => `translate(${d.y},${d.x})`)

node.append('circle')
	.attr('fill', '#555')
	.attr('r', 2.5)

node.append('text')
	.attr('dy', '0.31em')
	.attr('x', d => d.children ? -6 : 6)
	.text(d => d.data.name)
	.filter(d => d.children)
	.attr('text-anchor', 'end')
	.clone(true).lower()
	.attr('stroke', 'white')


</script>
</body>
</html>